<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>OcorrÃªncias Ativas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #fff; color: #000; transition: 0.3s; }
  .dark-mode { background-color: #121212; color: #e0e0e0; }
  .dark-mode table { background-color: #1e1e1e; color: #e0e0e0; }
  .dark-mode th { background-color: #2c2c2c; }
  .dark-mode td { border-color: #444; color: #e0e0e0; }
  .dark-mode select, .dark-mode input, .dark-mode button { background-color: #2c2c2c; color: #e0e0e0; border: 1px solid #555; }
  #modoToggle { margin-bottom: 20px; padding: 6px 12px; cursor: pointer; }
  #filtros { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
  select, input, button { padding: 6px; font-size: 14px; }
  button { cursor: pointer; }
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .estado-conclusao { background-color: #d4f4d7; }
  .estado-curso { background-color: #f8d4d4; }
  .estado-despacho { background-color: #ffe5b4; }
  .estado-resolucao { background-color: #d4e4f8; }
  .dark-mode .estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
  .dark-mode .estado-curso { background-color: #5a2e2e; color: #e0e0e0; }
  .dark-mode .estado-despacho { background-color: #5a4a2e; color: #e0e0e0; }
  .dark-mode .estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }

  /* Cards de estatÃ­sticas */
  #estatisticas { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  .card {
    flex: 1 1 150px;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: transform 0.3s, background-color 0.3s;
    position: relative;
  }
  .card.animar { transform: scale(1.05); }
  .atualizado {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #4a90e2;
    color: #fff;
    padding: 8px 12px;
    border-radius: 5px;
    font-weight: bold;
    display: none;
  }
</style>
</head>
<body>

<div class="atualizado" id="msgAtualizado">âœ… Dados Atualizados</div>

<button id="modoToggle">ðŸŒ™ Alternar Modo</button>
<h1>OcorrÃªncias Ativas em Portugal</h1>

<div id="filtros">
  <select id="concelhoFiltro"><option value="">Concelho</option></select>
  <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
  <select id="estadoFiltro"><option value="">Estado</option></select>
  <select id="naturezaFiltro"><option value="">Natureza</option></select>
  <input type="text" id="pesquisa" placeholder="Pesquisar..." />
  <button id="limparFiltros">Limpar Filtros</button>
</div>

<div id="estatisticas"></div>

<div class="table-wrapper">
  <table id="ocorrencias">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Concelho</th>
        <th>Freguesia</th>
        <th>LocalizaÃ§Ã£o</th>
        <th>Natureza</th>
        <th>Estado</th>
        <th>OP</th>
        <th>MT</th>
        <th>MA</th>
        <th>MAq</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const tabela = document.querySelector('#ocorrencias tbody');
const concelhoFiltro = document.getElementById('concelhoFiltro');
const freguesiaFiltro = document.getElementById('freguesiaFiltro');
const estadoFiltro = document.getElementById('estadoFiltro');
const naturezaFiltro = document.getElementById('naturezaFiltro');
const pesquisaInput = document.getElementById('pesquisa');
const modoToggle = document.getElementById('modoToggle');
const msgAtualizado = document.getElementById('msgAtualizado');

if (localStorage.getItem('modo') === 'dark') document.body.classList.add('dark-mode');
modoToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('modo', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
});

function formatarData(d) {
  if (!d) return 'â€”';
  const data = typeof d === 'number' ? new Date(d) : new Date(d);
  if (isNaN(data)) return 'â€”';
  return data.toLocaleString('pt-PT');
}

let todasOcorrencias = [];

const apiURL = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*';
const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(apiURL);

function carregarDados() {
  fetch(proxy)
    .then(res => res.json())
    .then(data => {
      todasOcorrencias = data.features.map(f => {
        const p = f.properties;
        return {
          ID_oc: p.OBJECTID,
          DataHora: p.DataInicioOcorrencia,
          Concelho: p.Concelho || 'â€”',
          Freguesia: p.Freguesia || 'â€”',
          Localizacao: p.Localidade || 'â€”',
          Natureza: p.Natureza || 'â€”',
          Estado: p.EstadoAgrupado || p.EstadoOcorrencia || 'â€”',
          Operacionais: p.Operacionais || 0,
          Veiculos: p.NumeroMeiosTerrestresEnvolvidos || 0,
          Aereos: p.NumeroMeiosAereosEnvolvidos || 0,
          Aquaticos: p.NumeroMeiosAquaticos || 0
        };
      });
      preencherFiltros();
      atualizarTabela();
      mostrarAtualizado();
    })
    .catch(err => console.error("Erro ao carregar dados:", err));
}

function preencherFiltros() {
  function criarOpcoes(array, select) {
    const valores = [...new Set(array.filter(Boolean))].sort();
    select.innerHTML = `<option value="">${select.id.replace('Filtro','')}</option>`;
    valores.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.textContent=v; select.appendChild(opt); });
  }
  criarOpcoes(todasOcorrencias.map(o => o.Concelho), concelhoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Estado), estadoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Natureza), naturezaFiltro);
  atualizarFreguesias();
}

function atualizarFreguesias() {
  const conc = concelhoFiltro.value;
  let freguesias = todasOcorrencias
    .filter(o => !conc || o.Concelho === conc)
    .map(o => o.Freguesia);
  freguesias = [...new Set(freguesias)].sort();
  freguesiaFiltro.innerHTML = `<option value="">Freguesia</option>`;
  freguesias.forEach(f => { const opt = document.createElement('option'); opt.value=f; opt.textContent=f; freguesiaFiltro.appendChild(opt); });
}

function atualizarTabela() {
  const filtradas = todasOcorrencias.filter(o => {
    const texto = `${o.Concelho} ${o.Freguesia} ${o.Localizacao} ${o.Estado} ${o.Natureza}`.toLowerCase();
    return (!concelhoFiltro.value || o.Concelho === concelhoFiltro.value) &&
           (!freguesiaFiltro.value || o.Freguesia === freguesiaFiltro.value) &&
           (!estadoFiltro.value || o.Estado === estadoFiltro.value) &&
           (!naturezaFiltro.value || o.Natureza === naturezaFiltro.value) &&
           (!pesquisaInput.value || texto.includes(pesquisaInput.value.toLowerCase()));
  });

  const existentes = {};
  Array.from(tabela.rows).forEach(tr => { existentes[tr.dataset.id] = tr; });

  const novosIDs = new Set();
  filtradas.forEach(o => {
    const id = o.ID_oc;
    novosIDs.add(id);
    const conteudo = `
      <td>${formatarData(o.DataHora)}</td>
      <td>${o.Concelho}</td>
      <td>${o.Freguesia}</td>
      <td>${o.Localizacao}</td>
      <td>${o.Natureza}</td>
      <td>${o.Estado}</td>
      <td>${o.Operacionais}</td>
      <td>${o.Veiculos}</td>
      <td>${o.Aereos}</td>
      <td>${o.Aquaticos}</td>
    `;
    if (existentes[id]) {
      if (existentes[id].innerHTML !== conteudo) {
        existentes[id].innerHTML = conteudo;
      }
      delete existentes[id];
    } else {
      const tr = document.createElement('tr');
      tr.dataset.id = id;
      tr.innerHTML = conteudo;
      const estadoLower = o.Estado.toLowerCase();
      if(estadoLower.includes('conclusÃ£o')) tr.className='estado-conclusao';
      else if(estadoLower.includes('curso')) tr.className='estado-curso';
      else if(estadoLower.includes('despacho')) tr.className='estado-despacho';
      else if(estadoLower.includes('resoluÃ§Ã£o')) tr.className='estado-resolucao';
      tabela.appendChild(tr);
    }
  });
  Object.values(existentes).forEach(tr => tr.remove());

  atualizarCards(filtradas);
}

function atualizarCards(filtradas) {
  const totalOperacionais = filtradas.reduce((s,o)=>s+o.Operacionais,0);
  const totalVeiculos = filtradas.reduce((s,o)=>s+o.Veiculos,0);
  const totalAereos = filtradas.reduce((s,o)=>s+o.Aereos,0);
  const totalAquaticos = filtradas.reduce((s,o)=>s+o.Aquaticos,0);

  const estatisticasDiv = document.getElementById('estatisticas');
  const cards = [
    { titulo: 'OcorrÃªncias visÃ­veis', valor: filtradas.length, cor:'#4a90e2' },
    { titulo: 'Operacionais', valor: totalOperacionais, cor:'#1f7a4c' },
    { titulo: 'VeÃ­culos', valor: totalVeiculos, cor:'#f5a623' },
    { titulo: 'AÃ©reos', valor: totalAereos, cor:'#9013fe' },
    { titulo: 'AquÃ¡ticos', valor: totalAquaticos, cor:'#b8e986' }
  ];

  function corTexto(cor) {
    const r = parseInt(cor.slice(1,3),16);
    const g = parseInt(cor.slice(3,5),16);
    const b = parseInt(cor.slice(5,7),16);
    return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff';
  }

  estatisticasDiv.innerHTML = '';
  cards.forEach(c => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.backgroundColor = c.cor;
    card.style.color = corTexto(c.cor);
    card.innerHTML = `<div>${c.titulo}</div><div style="font-size:1.5em; margin-top:5px;">${c.valor}</div>`;
    estatisticasDiv.appendChild(card);
    setTimeout(() => card.classList.add('animar'), 50);
    setTimeout(() => card.classList.remove('animar'), 350);
  });
}

function mostrarAtualizado() {
  msgAtualizado.style.display = 'block';
  setTimeout(() => { msgAtualizado.style.display = 'none'; }, 2000);
}

// Filtros
concelhoFiltro.addEventListener('change', () => { atualizarFreguesias(); atualizarTabela(); });
freguesiaFiltro.addEventListener('change', atualizarTabela);
estadoFiltro.addEventListener('change', atualizarTabela);
naturezaFiltro.addEventListener('change', atualizarTabela);
pesquisaInput.addEventListener('input', atualizarTabela);
document.getElementById('limparFiltros').addEventListener('click', () => {
  concelhoFiltro.value = '';
  freguesiaFiltro.value = '';
  estadoFiltro.value = '';
  naturezaFiltro.value = '';
  pesquisaInput.value = '';
  atualizarTabela();
});

// AtualizaÃ§Ã£o automÃ¡tica a cada 30 segundos
setInterval(() => {
  carregarDados();
}, 30000);

// Carregar inicialmente
carregarDados();
</script>

</body>
</html>
