<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Ocorr√™ncias Ativas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #fff; color: #000; transition: 0.3s; }
  .dark-mode { background-color: #121212; color: #e0e0e0; }
  .dark-mode table { background-color: #1e1e1e; color: #e0e0e0; }
  .dark-mode th { background-color: #2c2c2c; }
  .dark-mode td { border-color: #444; color: #e0e0e0; }
  .dark-mode select, .dark-mode input, .dark-mode button { background-color: #2c2c2c; color: #e0e0e0; border: 1px solid #555; }
  #modoToggle { margin-bottom: 20px; padding: 6px 12px; cursor: pointer; }
  #filtros { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
  select, input, button { padding: 6px; font-size: 14px; }
  button { cursor: pointer; }
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .estado-conclusao { background-color: #d4f4d7; }
  .estado-curso { background-color: #f8d4d4; }
  .estado-despacho { background-color: #ffe5b4; }
  .estado-resolucao { background-color: #d4e4f8; }
  .dark-mode .estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
  .dark-mode .estado-curso { background-color: #5a2e2e; color: #e0e0e0; }
  .dark-mode .estado-despacho { background-color: #5a4a2e; color: #e0e0e0; }
  .dark-mode .estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }

  /* Cards de estat√≠sticas */
  #estatisticas { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  .card { flex: 1 1 150px; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<button id="modoToggle">üåô Alternar Modo</button>
<h1>Ocorr√™ncias Ativas em Portugal</h1>

<div id="filtros">
  <select id="concelhoFiltro"><option value="">Concelho</option></select>
  <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
  <select id="estadoFiltro"><option value="">Estado</option></select>
  <select id="naturezaFiltro"><option value="">Natureza</option></select>
  <input type="text" id="pesquisa" placeholder="Pesquisar..." />
  <button id="limparFiltros">Limpar Filtros</button>
</div>

<div id="estatisticas"></div>

<div class="table-wrapper">
  <table id="ocorrencias">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Concelho</th>
        <th>Freguesia</th>
        <th>Localiza√ß√£o</th>
        <th>Natureza</th>
        <th>Estado</th>
        <th>Operacionais</th>
        <th>Ve√≠culos</th>
        <th>A√©reos</th>
        <th>Aqu√°ticos</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const tabela = document.querySelector('#ocorrencias tbody');
const concelhoFiltro = document.getElementById('concelhoFiltro');
const freguesiaFiltro = document.getElementById('freguesiaFiltro');
const estadoFiltro = document.getElementById('estadoFiltro');
const naturezaFiltro = document.getElementById('naturezaFiltro');
const pesquisaInput = document.getElementById('pesquisa');
const modoToggle = document.getElementById('modoToggle');

if (localStorage.getItem('modo') === 'dark') document.body.classList.add('dark-mode');
modoToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('modo', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
});

function formatarData(d) {
  if (!d) return '‚Äî';
  const data = typeof d === 'number' ? new Date(d) : new Date(d);
  if (isNaN(data)) return '‚Äî';
  return data.toLocaleString('pt-PT');
}

let todasOcorrencias = [];

const apiURL = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*';
const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(apiURL);

fetch(proxy)
  .then(res => res.json())
  .then(data => {
    todasOcorrencias = data.features.map(f => {
      const p = f.properties;
      return {
        DataHora: p.DataInicioOcorrencia,
        Concelho: p.Concelho || '‚Äî',
        Freguesia: p.Freguesia || '‚Äî',
        Localizacao: p.Localidade || '‚Äî',
        Natureza: p.Natureza || '‚Äî',
        Estado: p.EstadoAgrupado || p.EstadoOcorrencia || '‚Äî',
        Operacionais: p.Operacionais || 0,
        Veiculos: p.NumeroMeiosTerrestresEnvolvidos || 0,
        Aereos: p.NumeroMeiosAereosEnvolvidos || 0,
        Aquaticos: p.NumeroMeiosAquaticos || 0
      };
    });
    preencherFiltros();
    atualizarTabela();
  })
  .catch(err => console.error("Erro ao carregar dados:", err));

function preencherFiltros() {
  function criarOpcoes(array, select) {
    const valores = [...new Set(array.filter(Boolean))].sort();
    select.innerHTML = `<option value="">${select.id.replace('Filtro','')}</option>`;
    valores.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.textContent=v; select.appendChild(opt); });
  }

  criarOpcoes(todasOcorrencias.map(o => o.Concelho), concelhoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Estado), estadoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Natureza), naturezaFiltro);
  atualizarFreguesias();
}

function atualizarFreguesias() {
  const conc = concelhoFiltro.value;
  let freguesias = todasOcorrencias
    .filter(o => !conc || o.Concelho === conc)
    .map(o => o.Freguesia);
  freguesias = [...new Set(freguesias)].sort();
  freguesiaFiltro.innerHTML = `<option value="">Freguesia</option>`;
  freguesias.forEach(f => { const opt = document.createElement('option'); opt.value=f; opt.textContent=f; freguesiaFiltro.appendChild(opt); });
}

function atualizarTabela() {
  const concelho = concelhoFiltro.value;
  const freguesia = freguesiaFiltro.value;
  const estado = estadoFiltro.value;
  const natureza = naturezaFiltro.value;
  const pesquisa = pesquisaInput.value.toLowerCase();

  const filtradas = todasOcorrencias.filter(o => {
    const texto = `${o.Concelho} ${o.Freguesia} ${o.Localizacao} ${o.Estado} ${o.Natureza}`.toLowerCase();
    return (!concelho || o.Concelho === concelho) &&
           (!freguesia || o.Freguesia === freguesia) &&
           (!estado || o.Estado === estado) &&
           (!natureza || o.Natureza === natureza) &&
           (!pesquisa || texto.includes(pesquisa));
  });

  const totalOperacionais = filtradas.reduce((s,o)=>s+o.Operacionais,0);
  const totalVeiculos = filtradas.reduce((s,o)=>s+o.Veiculos,0);
  const totalAereos = filtradas.reduce((s,o)=>s+o.Aereos,0);
  const totalAquaticos = filtradas.reduce((s,o)=>s+o.Aquaticos,0);

  const estatisticasDiv = document.getElementById('estatisticas');
  const cards = [
    { titulo: 'Ocorr√™ncias vis√≠veis', valor: filtradas.length, cor:'#4a90e2' },
    { titulo: 'Operacionais', valor: totalOperacionais, cor:'#50e3c2' },
    { titulo: 'Ve√≠culos', valor: totalVeiculos, cor:'#f5a623' },
    { titulo: 'A√©reos', valor: totalAereos, cor:'#9013fe' },
    { titulo: 'Aqu√°ticos', valor: totalAquaticos, cor:'#b8e986' }
  ];

  // Fun√ß√£o para definir cor do texto conforme fundo
  function corTexto(cor) {
    const r = parseInt(cor.slice(1,3),16);
    const g = parseInt(cor.slice(3,5),16);
    const b = parseInt(cor.slice(5,7),16);
    return (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000' : '#fff';
  }

  estatisticasDiv.innerHTML = '';
  cards.forEach(c => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.backgroundColor = c.cor;
    card.style.color = corTexto(c.cor);
    card.innerHTML = `<div>${c.titulo}</div><div style="font-size:1.5em; margin-top:5px;">${c.valor}</div>`;
    estatisticasDiv.appendChild(card);
  });

  tabela.innerHTML = '';
  filtradas.forEach(o => {
    const tr = document.createElement('tr');
    let classe = '';
    const estadoLower = o.Estado.toLowerCase();
    if(estadoLower.includes('conclus√£o')) classe='estado-conclusao';
    else if(estadoLower.includes('curso')) classe='estado-curso';
    else if(estadoLower.includes('despacho')) classe='estado-despacho';
    else if(estadoLower.includes('resolu√ß√£o')) classe='estado-resolucao';
    tr.className = classe;

    tr.innerHTML = `
      <td>${formatarData(o.DataHora)}</td>
      <td>${o.Concelho}</td>
      <td>${o.Freguesia}</td>
      <td>${o.Localizacao}</td>
      <td>${o.Natureza}</td>
      <td>${o.Estado}</td>
      <td>${o.Operacionais}</td>
      <td>${o.Veiculos}</td>
      <td>${o.Aereos}</td>
      <td>${o.Aquaticos}</td>
    `;
    tabela.appendChild(tr);
  });
}

concelhoFiltro.addEventListener('change', () => { atualizarFreguesias(); atualizarTabela(); });
freguesiaFiltro.addEventListener('change', atualizarTabela);
estadoFiltro.addEventListener('change', atualizarTabela);
naturezaFiltro.addEventListener('change', atualizarTabela);
pesquisaInput.addEventListener('input', atualizarTabela);

document.getElementById('limparFiltros').addEventListener('click', () => {
  concelhoFiltro.value = '';
  freguesiaFiltro.value = '';
  estadoFiltro.value = '';
  naturezaFiltro.value = '';
  pesquisaInput.value = '';
  preencherFiltros();
  atualizarTabela();
});
</script>

</body>
</html>
