<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>OcorrÃªncias Ativas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode { background-color: #121212; color: #e0e0e0; }
    .dark-mode table { background-color: #1e1e1e; color: #e0e0e0; }
    .dark-mode th { background-color: #2c2c2c; }
    .dark-mode td { border-color: #444; color: #e0e0e0; }
    .dark-mode select, .dark-mode input, .dark-mode button {
      background-color: #2c2c2c; color: #e0e0e0; border: 1px solid #555;
    }
    #modoToggle { margin-bottom: 20px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
    #filtros { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    select, input { padding: 6px; font-size: 14px; }
    button { padding: 6px 12px; font-size: 14px; cursor: pointer; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .estado-conclusao { background-color: #d4f4d7; color: #000; }
    .estado-curso     { background-color: #f8d4d4; color: #000; }
    .estado-despacho  { background-color: #ffe5b4; color: #000; }
    .estado-resolucao { background-color: #d4e4f8; color: #000; }
    .dark-mode .estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
    .dark-mode .estado-curso     { background-color: #5a2e2e; color: #e0e0e0; }
    .dark-mode .estado-despacho  { background-color: #5a4a2e; color: #e0e0e0; }
    .dark-mode .estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }
  </style>
</head>
<body>

  <button id="modoToggle">ðŸŒ™ Alternar Modo</button>
  <h1>OcorrÃªncias Ativas em Portugal</h1>

  <div id="filtros">
    <select id="distritoFiltro"><option value="">Distrito</option></select>
    <select id="concelhoFiltro"><option value="">Concelho</option></select>
    <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
    <select id="estadoFiltro"><option value="">Estado</option></select>
    <select id="naturezaFiltro"><option value="">Natureza</option></select>
    <input type="text" id="pesquisa" placeholder="Pesquisar..." />
    <button id="limparFiltros">Limpar Filtros</button>
  </div>

  <div id="estatisticas"></div>

  <div class="table-wrapper">
    <table id="ocorrencias">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Distrito</th>
          <th>Concelho</th>
          <th>Freguesia</th>
          <th>LocalizaÃ§Ã£o</th>
          <th>Natureza</th>
          <th>Estado</th>
          <th>Operacionais</th>
          <th>VeÃ­culos</th>
          <th>AÃ©reos</th>
          <th>AquÃ¡ticos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const tabela = document.querySelector('#ocorrencias tbody');
  const distritoFiltro = document.getElementById('distritoFiltro');
  const concelhoFiltro = document.getElementById('concelhoFiltro');
  const freguesiaFiltro = document.getElementById('freguesiaFiltro');
  const estadoFiltro = document.getElementById('estadoFiltro');
  const naturezaFiltro = document.getElementById('naturezaFiltro');
  const pesquisaInput = document.getElementById('pesquisa');
  const modoToggle = document.getElementById('modoToggle');

  if (localStorage.getItem('modo') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  modoToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('modo', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });

  let todasOcorrencias = [];

  const novaAPI = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=json&where=1=1&outFields=*';
  const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(novaAPI);

  fetch(proxy)
    .then(res => res.json())
    .then(data => {
      todasOcorrencias = data.features.map(f => ({ ...f.attributes }));
      preencherFiltros(todasOcorrencias);
      atualizarTabela();
    })
    .catch(err => console.error("Erro ao carregar dados:", err));

  function preencherFiltros(data) {
    const distritos = [...new Set(data.map(o => o.Distrito).filter(Boolean))];
    const concelhos = [...new Set(data.map(o => o.Concelho).filter(Boolean))];
    const freguesias = [...new Set(data.map(o => o.Freguesia).filter(Boolean))];
    const estados = [...new Set(data.map(o => o.Estado).filter(Boolean))];
    const naturezas = [...new Set(data.map(o => o.Natureza).filter(Boolean))];

    [distritos, concelhos, freguesias, estados, naturezas].forEach((lista, i) => {
      const filtro = [distritoFiltro, concelhoFiltro, freguesiaFiltro, estadoFiltro, naturezaFiltro][i];
      lista.forEach(valor => {
        const opt = document.createElement('option');
        opt.value = valor;
        opt.textContent = valor;
        filtro.appendChild(opt);
      });
    });
  }

  function atualizarTabela() {
    const distrito = distritoFiltro.value;
    const concelho = concelhoFiltro.value;
    const freguesia = freguesiaFiltro.value;
    const estado = estadoFiltro.value;
    const natureza = naturezaFiltro.value;
    const pesquisa = pesquisaInput.value.toLowerCase();

    const filtradas = todasOcorrencias.filter(o => {
      const texto = `${o.Distrito} ${o.Concelho} ${o.Freguesia} ${o.Localizacao} ${o.Estado} ${o.Natureza}`.toLowerCase();
      return (!distrito || o.Distrito === distrito) &&
             (!concelho || o.Concelho === concelho) &&
             (!freguesia || o.Freguesia === freguesia) &&
             (!estado || o.Estado === estado) &&
             (!natureza || o.Natureza === natureza) &&
             (!pesquisa || texto.includes(pesquisa));
    });

    // EstatÃ­sticas simples
    let estatisticasHTML = `<h3>ðŸ“Š EstatÃ­sticas</h3>
      <p><strong>OcorrÃªncias visÃ­veis:</strong> ${filtradas.length}</p>`;
    document.getElementById('estatisticas').innerHTML = estatisticasHTML;

    tabela.innerHTML = '';
    filtradas.forEach(o => {
      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${o.DataOcorrencia || 'â€”'} ${o.HoraOcorrencia || ''}</td>
        <td>${o.Distrito || 'â€”'}</td>
        <td>${o.Concelho || 'â€”'}</td>
        <td>${o.Freguesia || 'â€”'}</td>
        <td>${o.Localizacao || 'â€”'}</td>
        <td>${o.Natureza || 'â€”'}</td>
        <td>${o.Estado || 'â€”'}</td>
        <td>${o.MeiosHumanos || 0}</td>
        <td>${o.MeiosTerrestres || 0}</td>
        <td>${o.MeiosAereos || 0}</td>
        <td>${o.MeiosAquaticos || 0}</td>
      `;
      tabela.appendChild(linha);
    });
  }

  [distritoFiltro, concelhoFiltro, freguesiaFiltro, estadoFiltro, naturezaFiltro].forEach(f => f.addEventListener('change', atualizarTabela));
  pesquisaInput.addEventListener('input', atualizarTabela);

  document.getElementById('limparFiltros').addEventListener('click', () => {
    distritoFiltro.value = '';
    concelhoFiltro.value = '';
    freguesiaFiltro.value = '';
    estadoFiltro.value = '';
    naturezaFiltro.value = '';
    pesquisaInput.value = '';
    atualizarTabela();
  });
</script>

</body>
</html>
