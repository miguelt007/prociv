<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Ocorr√™ncias Ativas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #fff; color: #000; transition: 0.3s; }
  .dark-mode { background-color: #121212; color: #e0e0e0; }
  .dark-mode table { background-color: #1e1e1e; color: #e0e0e0; }
  .dark-mode th { background-color: #2c2c2c; }
  .dark-mode td { border-color: #444; color: #e0e0e0; }
  .dark-mode select, .dark-mode input, .dark-mode button { background-color: #2c2c2c; color: #e0e0e0; border: 1px solid #555; }
  #modoToggle { margin-bottom: 20px; padding: 6px 12px; cursor: pointer; }
  #filtros { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
  select, input, button { padding: 6px; font-size: 14px; }
  button { cursor: pointer; }
  .table-wrapper { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 800px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  .estado-conclusao { background-color: #d4f4d7; }
  .estado-curso { background-color: #f8d4d4; }
  .estado-despacho { background-color: #ffe5b4; }
  .estado-resolucao { background-color: #d4e4f8; }
  .dark-mode .estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
  .dark-mode .estado-curso { background-color: #5a2e2e; color: #e0e0e0; }
  .dark-mode .estado-despacho { background-color: #5a4a2e; color: #e0e0e0; }
  .dark-mode .estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }

  /* Cards de estat√≠sticas */
  #estatisticas { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
  .card {
    flex: 1 1 150px;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: transform 0.3s, background-color 0.3s;
    position: relative;
  }

  /* Anima√ß√£o de piscada c√©lula a c√©lula */
  @keyframes piscar-celula {
    0%, 100% { background-color: inherit; }
    50% { background-color: yellow; }
  }
  .piscar-celula { animation: piscar-celula 1s ease-in-out 3; }

  .atualizado {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #4a90e2;
    color: #fff;
    padding: 8px 12px;
    border-radius: 5px;
    font-weight: bold;
    display: none;
  }
</style>
</head>
<body>

<div class="atualizado" id="msgAtualizado">‚úÖ Dados Atualizados</div>

<button id="modoToggle">üåô Alternar Modo</button>
<h1>Ocorr√™ncias Ativas em Portugal</h1>

<div id="filtros">
  <select id="concelhoFiltro"><option value="">Concelho</option></select>
  <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
  <select id="estadoFiltro"><option value="">Estado</option></select>
  <select id="naturezaFiltro"><option value="">Natureza</option></select>
  <input type="text" id="pesquisa" placeholder="Pesquisar..." />
  <button id="limparFiltros">Limpar Filtros</button>
</div>

<div id="estatisticas"></div>

<div class="table-wrapper">
  <table id="ocorrencias">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Concelho</th>
        <th>Freguesia</th>
        <th>Localiza√ß√£o</th>
        <th>Natureza</th>
        <th>Estado</th>
        <th>OP</th>
        <th>MT</th>
        <th>MA</th>
        <th>MAq</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const tabela = document.querySelector('#ocorrencias tbody');
const concelhoFiltro = document.getElementById('concelhoFiltro');
const freguesiaFiltro = document.getElementById('freguesiaFiltro');
const estadoFiltro = document.getElementById('estadoFiltro');
const naturezaFiltro = document.getElementById('naturezaFiltro');
const pesquisaInput = document.getElementById('pesquisa');
const modoToggle = document.getElementById('modoToggle');
const msgAtualizado = document.getElementById('msgAtualizado');

if (localStorage.getItem('modo') === 'dark') document.body.classList.add('dark-mode');
modoToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('modo', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
});

function formatarData(d) {
  if (!d) return '‚Äî';
  const data = typeof d === 'number' ? new Date(d) : new Date(d);
  if (isNaN(data)) return '‚Äî';
  return data.toLocaleString('pt-PT');
}

function capitalizar(texto) {
  if (!texto) return '';
  return texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();
}

let todasOcorrencias = [];
let tabelaAnterior = {}; // armazena hash das linhas anteriores
const apiURL = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*';
const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(apiURL);

function carregarDados() {
  fetch(proxy)
    .then(res => res.json())
    .then(data => {
      todasOcorrencias = data.features.map(f => {
        const p = f.properties;
        return {
          ID_oc: p.OBJECTID,
          DataHora: p.DataInicioOcorrencia,
          Concelho: p.Concelho || '‚Äî',
          Freguesia: p.Freguesia || '‚Äî',
          Localizacao: p.Localidade || '‚Äî',
          Natureza: p.Natureza || '‚Äî',
          Estado: p.EstadoAgrupado || p.EstadoOcorrencia || '‚Äî',
          Operacionais: p.Operacionais || 0,
          Veiculos: p.NumeroMeiosTerrestresEnvolvidos || 0,
          Aereos: p.NumeroMeiosAereosEnvolvidos || 0,
          Aquaticos: p.NumeroMeiosAquaticos || 0
        };
      });
      preencherFiltros();
      atualizarTabela();
      mostrarAtualizado();
    })
    .catch(err => console.error("Erro ao carregar dados:", err));
}

function criarOpcoes(array, select) {
  const valores = [...new Set(array.filter(Boolean))].sort();
  select.innerHTML = `<option value="">${capitalizar(select.id.replace('Filtro',''))}</option>`;
  valores.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = capitalizar(v);
    select.appendChild(opt);
  });
}

function preencherFiltros() {
  criarOpcoes(todasOcorrencias.map(o => o.Concelho), concelhoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Estado), estadoFiltro);
  criarOpcoes(todasOcorrencias.map(o => o.Natureza), naturezaFiltro);
  atualizarFreguesias();
}

function atualizarFreguesias() {
  const conc = concelhoFiltro.value;
  let freguesias = todasOcorrencias
    .filter(o => !conc || o.Concelho === conc)
    .map(o => o.Freguesia);
  freguesias = [...new Set(freguesias)].sort();
  freguesiaFiltro.innerHTML = `<option value="">Freguesia</option>`;
  freguesias.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f;
    opt.textContent = capitalizar(f);
    freguesiaFiltro.appendChild(opt);
  });
}

function atualizarTabela() {
  const concelho = concelhoFiltro.value;
  const freguesia = freguesiaFiltro.value;
  const estado = estadoFiltro.value;
  const natureza = naturezaFiltro.value;
  const pesquisa = pesquisaInput.value.toLowerCase();

  const filtradas = todasOcorrencias.filter(o => {
    const texto = `${o.Concelho} ${o.Freguesia} ${o.Localizacao} ${o.Estado} ${o.Natureza}`.toLowerCase();
    return (!concelho || o.Concelho === concelho) &&
           (!freguesia || o.Freguesia === freguesia) &&
           (!estado || o.Estado === estado) &&
           (!natureza || o.Natureza === natureza) &&
           (!pesquisa || texto.includes(pesquisa));
  });

  tabela.innerHTML = '';
  filtradas.forEach(o => {
    const linha = document.createElement('tr');
    const estadoTexto = o.Estado ? o.Estado.toLowerCase() : '';
    let classeEstado = '';
    if (estadoTexto.includes('conclus√£o')) classeEstado = 'estado-conclusao';
    else if (estadoTexto.includes('curso')) classeEstado = 'estado-curso';
    else if (estadoTexto.includes('despacho')) classeEstado = 'estado-despacho';
    else if (estadoTexto.includes('resolu√ß√£o')) classeEstado = 'estado-resolucao';
    if (classeEstado) linha.classList.add(classeEstado);

    linha.innerHTML = `
      <td>${formatarData(o.DataHora)}</td>
      <td>${o.Concelho}</td>
      <td>${o.Freguesia}</td>
      <td>${o.Localizacao}</td>
      <td>${o.Natureza}</td>
      <td>${o.Estado}</td>
      <td>${o.Operacionais}</td>
      <td>${o.Veiculos}</td>
      <td>${o.Aereos}</td>
      <td>${o.Aquaticos}</td>
    `;

    const hash = JSON.stringify(o);
    if (!tabelaAnterior[o.ID_oc] || tabelaAnterior[o.ID_oc] !== hash) {
      linha.classList.add('piscar-celula');
    }
    tabelaAnterior[o.ID_oc] = hash;

    tabela.appendChild(linha);
  });

  atualizarCards(filtradas);
}

function atualizarCards(filtradas) {
  const totalOcorrencias = filtradas.length;
  const totalOperacionais = filtradas.reduce((s,o)=>s+o.Operacionais,0);
  const totalVeiculos = filtradas.reduce((s,o)=>s+o.Veiculos,0);
  const totalAereos = filtradas.reduce((s,o)=>s+o.Aereos,0);
  const totalAquaticos = filtradas.reduce((s,o)=>s+o.Aquaticos,0);

  const container = document.getElementById('estatisticas');
  container.innerHTML = '';

  function criarCard(titulo, valor, cor='#4a90e2', textoCor='#fff', icone='') {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.backgroundColor = cor;
    card.style.color = textoCor;
    card.innerHTML = `
      <div style="font-size:1.2em;">${icone} ${titulo}</div>
      <div style="font-size:1.5em; margin-top:5px;">${valor}</div>
    `;
    container.appendChild(card);
  }

  criarCard('Ocorr√™ncias', totalOcorrencias, '#4a90e2', '#fff', 'üìå');
  criarCard('Operacionais', totalOperacionais, '#d4f4d7', '#000', 'üë®‚Äçüöí');
  criarCard('Ve√≠culos', totalVeiculos, '#f8d4d4', '#000', 'üöí');
  criarCard('A√©reos', totalAereos, '#ffe5b4', '#000', 'üöÅ');
  criarCard('Aqu√°ticos', totalAquaticos, '#d4e4f8', '#000', 'üö§');
}

function mostrarAtualizado() {
  msgAtualizado.style.display = 'block';
  setTimeout(() => { msgAtualizado.style.display = 'none'; }, 2000);
}

concelhoFiltro.addEventListener('change', () => { atualizarFreguesias(); atualizarTabela(); });
freguesiaFiltro.addEventListener('change', atualizarTabela);
estadoFiltro.addEventListener('change', atualizarTabela);
naturezaFiltro.addEventListener('change', atualizarTabela);
pesquisaInput.addEventListener('input', atualizarTabela);

document.getElementById('limparFiltros').addEventListener('click', () => {
  concelhoFiltro.value = '';
  freguesiaFiltro.value = '';
  estadoFiltro.value = '';
  naturezaFiltro.value = '';
  pesquisaInput.value = '';
  atualizarTabela();
});

// Atualiza√ß√£o autom√°tica a cada 60 segundos
setInterval(() => { carregarDados(); }, 180000);

// Carregar dados inicialmente
carregarDados();
</script>
</body>
</html>
