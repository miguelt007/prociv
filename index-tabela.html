<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Tabela Ocorr√™ncias</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    h1 {
      text-align: center;
    }
    #modoToggle {
      margin-bottom: 20px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #filtros {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    select {
      padding: 6px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
    }
    body.dark-mode select {
      background: #2c2c2c;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    body.dark-mode table {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }
    th {
      background: #eee;
    }
    body.dark-mode th {
      background-color: #2c2c2c;
    }
    body.dark-mode td {
      border-color: #444;
    }
    tr.estado-conclusao { background-color: #d4f4d7; color: #000; }
    tr.estado-curso     { background-color: #f8d4d4; color: #000; }
    tr.estado-despacho  { background-color: #ffe5b4; color: #000; }
    tr.estado-resolucao { background-color: #d4e4f8; color: #000; }
    body.dark-mode tr.estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
    body.dark-mode tr.estado-curso     { background-color: #5a2e2e; color: #e0e0e0; }
    body.dark-mode tr.estado-despacho  { background-color: #5a4a2e; color: #e0e0e0; }
    body.dark-mode tr.estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }

    tr.piscar-celula {
      animation: piscar 1s ease-in-out 2;
    }
    @keyframes piscar {
      0% { background-color: yellow; }
      100% { background-color: inherit; }
    }

    .cards {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .card {
      padding: 10px;
      border-radius: 10px;
      min-width: 120px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
      flex: 0 0 auto;
    }
    .card h3 {
      margin: 0 0 5px;
      font-size: 1em;
    }
    .ocorrencia-critica {
      margin-bottom: 6px;
      padding: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      text-align: left;
    }
  </style>
</head>
<body>
  <button id="modoToggle">üåô Alternar Modo</button>
  <h1>Ocorr√™ncias PROCIV</h1>

  <div id="filtros">
    <select id="concelhoFiltro"></select>
    <select id="freguesiaFiltro"></select>
    <select id="naturezaFiltro"></select>
    <select id="estadoFiltro"></select>
  </div>

  <div id="cardsContainer" class="cards"></div>

  <table id="tabelaOcorrencias">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Concelho</th>
        <th>Freguesia</th>
        <th>Localidade</th>
        <th>Natureza</th>
        <th>Estado</th>
        <th>OP</th>
        <th>MT</th>
        <th>MA</th>
        <th>MAq</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const url = "https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*";
    let ocorrencias = [];
    let tabelaAnterior = {};

    const modoSalvo = localStorage.getItem('modo');
    if(modoSalvo === 'dark') document.body.classList.add('dark-mode');

    document.getElementById('modoToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const modoAtual = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
      localStorage.setItem('modo', modoAtual);
    });

    function capitalizar(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : '';
    }

    function formatarData(dataStr) {
      if (!dataStr) return '‚Äî';
      const d = new Date(dataStr);
      return d.toLocaleString('pt-PT');
    }

    function criarOpcoes(array, select) {
      const valores = [...new Set(array.filter(Boolean))].sort();
      select.innerHTML = `<option value="">${capitalizar(select.id.replace('Filtro',''))}</option>`;
      valores.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = capitalizar(v);
        select.appendChild(opt);
      });
    }

    function criarCard(titulo, valor, cor='#4a90e2', textoCor='#fff', icone='') {
      const container = document.getElementById('cardsContainer');
      const card = document.createElement('div');
      card.className = 'card';
      card.style.backgroundColor = cor;
      card.style.color = textoCor;
      card.innerHTML = `
        <div style="font-size:1.1em;">${icone} ${titulo}</div>
        <div style="font-size:1.4em; margin-top:5px;">${valor}</div>
      `;
      container.appendChild(card);
    }

    function atualizarCards() {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';

      const totalOcorrencias = ocorrencias.length;
      const totalOperacionais = ocorrencias.reduce((s, o) => s + (o.Operacionais || 0), 0);
      const totalVeiculos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosTerrestresEnvolvidos || 0), 0);
      const totalAereos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosAereosEnvolvidos || 0), 0);
      const totalAquaticos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosAquaticos || 0), 0);

      criarCard('Ocorr√™ncias', totalOcorrencias, '#4a90e2', '#fff', 'üìå');
      criarCard('Operacionais', totalOperacionais, '#d4f4d7', '#000', 'üë®‚Äçüöí');
      criarCard('Ve√≠culos', totalVeiculos, '#f8d4d4', '#000', 'üöí');
      criarCard('A√©reos', totalAereos, '#ffe5b4', '#000', 'üöÅ');
      criarCard('Aqu√°ticos', totalAquaticos, '#d4e4f8', '#000', 'üö§');

      const criticas = ocorrencias.filter(o => {
        const estadoOk = o.EstadoAgrupado === "Em Curso" || o.EstadoAgrupado === "Em Conclus√£o";

        let duracaoOk = false;
        if (o.DataInicioOcorrencia) {
          const inicio = new Date(o.DataInicioOcorrencia);
          const fim = new Date(o.DataDosDados || Date.now());
          const diffMin = (fim - inicio) / 60000;
          duracaoOk = diffMin >= 180;
        }

        const operacionaisOk = (o.Operacionais || 0) >= 100;
        return estadoOk && duracaoOk && operacionaisOk;
      });

      if (criticas.length > 0) {
        const criticasDiv = document.createElement('div');
        criticasDiv.className = 'card';
        criticasDiv.style.backgroundColor = '#ff4d4d';
        criticasDiv.style.color = '#fff';
        criticasDiv.style.flex = '1 1 100%';
        criticasDiv.innerHTML = `<h3>üî• Ocorr√™ncias Cr√≠ticas (${criticas.length})</h3>`;
        
        criticas.forEach(o => {
          let duracaoTexto = '‚Äî';
          if (o.DataInicioOcorrencia) {
            const inicio = new Date(o.DataInicioOcorrencia);
            const fim = new Date(o.DataDosDados || Date.now());
            const diffMs = fim - inicio;
            const horas = Math.floor(diffMs / 3600000);
            const minutos = Math.floor((diffMs % 3600000) / 60000);
            duracaoTexto = `${horas}h ${minutos}m`;
          }

          criticasDiv.innerHTML += `
            <div class="ocorrencia-critica">
              <strong>${o.Concelho || '‚Äî'} - ${o.Freguesia || o.Localidade || '‚Äî'}</strong><br>
              üå± ${o.Natureza || '‚Äî'} | üìå ${o.EstadoAgrupado || '‚Äî'}<br>
              üìÖ ${formatarData(o.DataInicioOcorrencia)} | ‚è≥ ${duracaoTexto}<br>
              üë®‚Äçüöí ${o.Operacionais || 0} | üöí ${o.NumeroMeiosTerrestresEnvolvidos || 0} | üöÅ ${o.NumeroMeiosAereosEnvolvidos || 0} | üö§ ${o.NumeroMeiosAquaticos || 0}
            </div>
          `;
        });

        container.appendChild(criticasDiv);
      }
    }

    function atualizarTabela() {
      const tabela = document.querySelector('#tabelaOcorrencias tbody');
      tabela.innerHTML = '';

      const concelhoFiltro = document.getElementById('concelhoFiltro').value;
      const freguesiaFiltro = document.getElementById('freguesiaFiltro').value;
      const naturezaFiltro = document.getElementById('naturezaFiltro').value;
      const estadoFiltro = document.getElementById('estadoFiltro').value;

      const filtradas = ocorrencias.filter(o => {
        return (!concelhoFiltro || o.Concelho === concelhoFiltro) &&
               (!freguesiaFiltro || o.Freguesia === freguesiaFiltro) &&
               (!naturezaFiltro || o.Natureza === naturezaFiltro) &&
               (!estadoFiltro || o.EstadoAgrupado === estadoFiltro);
      });

      filtradas.forEach(o => {
        const linha = document.createElement('tr');

        const estadoTexto = o.EstadoAgrupado ? o.EstadoAgrupado.toLowerCase() : '';
        let classeEstado = '';
        if (estadoTexto.includes('conclus√£o')) classeEstado = 'estado-conclusao';
        else if (estadoTexto.includes('curso')) classeEstado = 'estado-curso';
        else if (estadoTexto.includes('despacho')) classeEstado = 'estado-despacho';
        else if (estadoTexto.includes('resolu√ß√£o')) classeEstado = 'estado-resolucao';
        if (classeEstado) linha.classList.add(classeEstado);

        linha.innerHTML = `
          <td>${formatarData(o.DataInicioOcorrencia)}</td>
          <td>${o.Concelho || '‚Äî'}</td>
          <td>${o.Freguesia || '‚Äî'}</td>
          <td>${o.Localidade || '‚Äî'}</td>
          <td>${o.Natureza || '‚Äî'}</td>
          <td>${o.EstadoAgrupado || '‚Äî'}</td>
          <td>${o.Operacionais || 0}</td>
          <td>${o.NumeroMeiosTerrestresEnvolvidos || 0}</td>
          <td>${o.NumeroMeiosAereosEnvolvidos || 0}</td>
          <td>${o.NumeroMeiosAquaticos || 0}</td>
        `;

        const id = o.ID_oc;
        const hash = JSON.stringify(o);
        if (!tabelaAnterior[id] || tabelaAnterior[id] !== hash) {
          linha.classList.add('piscar-celula');
        }
        tabelaAnterior[id] = hash;

        tabela.appendChild(linha);
      });
    }

    async function carregarDados() {
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        ocorrencias = data.features.map(f => f.properties);

        criarOpcoes(ocorrencias.map(o => o.Concelho), document.getElementById('concelhoFiltro'));
        criarOpcoes(ocorrencias.map(o => o.Freguesia), document.getElementById('freguesiaFiltro'));
        criarOpcoes(ocorrencias.map(o => o.Natureza), document.getElementById('naturezaFiltro'));
        criarOpcoes(ocorrencias.map(o => o.EstadoAgrupado), document.getElementById('estadoFiltro'));

        atualizarCards();
        atualizarTabela();
      } catch (e) {
        console.error("Erro ao carregar dados", e);
      }
    }

    document.querySelectorAll('#filtros select').forEach(sel => sel.addEventListener('change', atualizarTabela));

    carregarDados();
    setInterval(carregarDados, 60000);
  </script>
</body>
</html>
