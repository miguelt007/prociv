<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Ocorr√™ncias Ativas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    #modoToggle {
      margin-bottom: 20px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    #filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    select, input, button {
      padding: 6px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .estado-conclusao { background-color: #d4f4d7; color: #000; }
    .estado-curso     { background-color: #f8d4d4; color: #000; }
    .estado-despacho  { background-color: #ffe5b4; color: #000; }
    .estado-resolucao { background-color: #d4e4f8; color: #000; }

    /* Cards */
    #cardsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
    }

    .card {
      flex: 1 1 180px;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 18px;
    }

    .card p {
      font-size: 22px;
      font-weight: bold;
      margin: 0;
    }

    .dark-mode .card {
      box-shadow: 0 2px 6px rgba(255,255,255,0.1);
    }

    /* Card cr√≠tico */
    .card.critico {
      background-color: #ff4d4d;
      color: #fff;
      flex: 1 1 100%;
    }

    .card.critico h3 {
      margin-bottom: 12px;
    }

    .ocorrencia-critica {
      padding: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      margin-bottom: 6px;
    }
  </style>
</head>
<body>

  <button id="modoToggle">üåô Alternar Modo</button>
  <h1>Ocorr√™ncias Ativas em Portugal</h1>

  <div id="filtros">
    <select id="concelhoFiltro"><option value="">Concelho</option></select>
    <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
    <select id="estadoFiltro"><option value="">Estado</option></select>
    <select id="naturezaFiltro"><option value="">Natureza</option></select>
    <input type="text" id="pesquisa" placeholder="Pesquisar..." />
    <button id="limparFiltros">Limpar Filtros</button>
  </div>

  <!-- Cards -->
  <div id="cardsContainer"></div>

  <div class="table-wrapper">
    <table id="ocorrencias">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Concelho</th>
          <th>Freguesia</th>
          <th>Localiza√ß√£o</th>
          <th>Natureza</th>
          <th>Estado</th>
          <th>Operacionais</th>
          <th>Ve√≠culos</th>
          <th>A√©reos</th>
          <th>Aqu√°ticos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const tabela = document.querySelector('#ocorrencias tbody');
  const concelhoFiltro = document.getElementById('concelhoFiltro');
  const freguesiaFiltro = document.getElementById('freguesiaFiltro');
  const estadoFiltro = document.getElementById('estadoFiltro');
  const naturezaFiltro = document.getElementById('naturezaFiltro');
  const pesquisaInput = document.getElementById('pesquisa');
  const modoToggle = document.getElementById('modoToggle');
  let ocorrencias = [];

  const apiURL = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*';

  if (localStorage.getItem('modo') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  modoToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const modoAtual = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
    localStorage.setItem('modo', modoAtual);
  });

  function formatarDataHora(dataISO) {
    if (!dataISO) return '‚Äî';
    const d = new Date(dataISO);
    return isNaN(d) ? '‚Äî' : d.toLocaleString('pt-PT');
  }

  fetch(apiURL)
    .then(res => res.json())
    .then(data => {
      ocorrencias = data.features.map(f => f.properties);
      preencherFiltros(ocorrencias);
      atualizarTabelaEcards();
    });

  function preencherFiltros(data) {
    const concelhos = [...new Set(data.map(o => o.Concelho).filter(Boolean))];
    const freguesias = [...new Set(data.map(o => o.Freguesia).filter(Boolean))];
    const estados = [...new Set(data.map(o => o.EstadoAgrupado).filter(Boolean))];
    const naturezas = [...new Set(data.map(o => o.Natureza).filter(Boolean))];

    [concelhos, freguesias, estados, naturezas].forEach((lista, i) => {
      const filtro = [concelhoFiltro, freguesiaFiltro, estadoFiltro, naturezaFiltro][i];
      lista.forEach(valor => {
        const opt = document.createElement('option');
        opt.value = valor;
        opt.textContent = valor;
        filtro.appendChild(opt);
      });
    });
  }

  function atualizarTabelaEcards() {
    const concelho = concelhoFiltro.value;
    const freguesia = freguesiaFiltro.value;
    const estado = estadoFiltro.value;
    const natureza = naturezaFiltro.value;
    const pesquisa = pesquisaInput.value.toLowerCase();

    const filtradas = ocorrencias.filter(o => {
      const texto = `${o.Concelho} ${o.Freguesia} ${o.Localidade} ${o.EstadoAgrupado} ${o.Natureza}`.toLowerCase();
      return (!concelho || o.Concelho === concelho) &&
             (!freguesia || o.Freguesia === freguesia) &&
             (!estado || o.EstadoAgrupado === estado) &&
             (!natureza || o.Natureza === natureza) &&
             (!pesquisa || texto.includes(pesquisa));
    });

    // --- Atualizar tabela
    tabela.innerHTML = '';
    filtradas.forEach(o => {
      const linha = document.createElement('tr');
      const estadoTexto = (o.EstadoAgrupado || '').toLowerCase();
      if (estadoTexto.includes('conclus√£o')) linha.classList.add('estado-conclusao');
      else if (estadoTexto.includes('curso')) linha.classList.add('estado-curso');
      else if (estadoTexto.includes('despacho')) linha.classList.add('estado-despacho');
      else if (estadoTexto.includes('resolu√ß√£o')) linha.classList.add('estado-resolucao');

      linha.innerHTML = `
        <td>${formatarDataHora(o.DataInicioOcorrencia)}</td>
        <td>${o.Concelho || '‚Äî'}</td>
        <td>${o.Freguesia || '‚Äî'}</td>
        <td>${o.Localidade || '‚Äî'}</td>
        <td>${o.Natureza || '‚Äî'}</td>
        <td>${o.EstadoAgrupado || '‚Äî'}</td>
        <td>${o.Operacionais || 0}</td>
        <td>${o.NumeroMeiosTerrestresEnvolvidos || 0}</td>
        <td>${o.NumeroMeiosAereosEnvolvidos || 0}</td>
        <td>${o.NumeroMeiosAquaticos || 0}</td>
      `;
      tabela.appendChild(linha);
    });

    atualizarCards(filtradas);
  }

  function criarCard(titulo, valor, corFundo, corTexto = '#000') {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.backgroundColor = corFundo;
    card.style.color = corTexto;
    card.innerHTML = `<h3>${titulo}</h3><p>${valor}</p>`;
    document.getElementById('cardsContainer').appendChild(card);
  }

  function atualizarCards(ocorrencias) {
    const container = document.getElementById('cardsContainer');
    container.innerHTML = '';

    const totalOcorrencias = ocorrencias.length;
    const totalOperacionais = ocorrencias.reduce((s, o) => s + (o.Operacionais || 0), 0);
    const totalVeiculos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosTerrestresEnvolvidos || 0), 0);
    const totalAereos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosAereosEnvolvidos || 0), 0);
    const totalAquaticos = ocorrencias.reduce((s, o) => s + (o.NumeroMeiosAquaticos || 0), 0);

    criarCard('üìå Ocorr√™ncias', totalOcorrencias, '#4a90e2', '#fff');
    criarCard('üë®‚Äçüöí Operacionais', totalOperacionais, '#d4f4d7', '#000');
    criarCard('üöí Ve√≠culos', totalVeiculos, '#f8d4d4', '#000');
    criarCard('üöÅ A√©reos', totalAereos, '#ffe5b4', '#000');
    criarCard('üö§ Aqu√°ticos', totalAquaticos, '#d4e4f8', '#000');

    // --- Ocorr√™ncias cr√≠ticas
    const criticas = ocorrencias.filter(o => {
      const estadoOk = o.EstadoAgrupado === "Em Curso" || o.EstadoAgrupado === "Em Conclus√£o";

      let duracaoOk = false;
      if (o.DataInicioOcorrencia) {
        const inicio = new Date(o.DataInicioOcorrencia);
        const fim = new Date(o.DataDosDados || Date.now());
        const diffMin = (fim - inicio) / 60000; // minutos
        duracaoOk = diffMin >= 180;
      }

      const operacionaisOk = (o.Operacionais || 0) >= 100;
      return estadoOk && duracaoOk && operacionaisOk;
    });

    if (criticas.length > 0) {
      const criticasDiv = document.createElement('div');
      criticasDiv.className = 'card critico';
      criticasDiv.innerHTML = `<h3>üî• Ocorr√™ncias Cr√≠ticas (${criticas.length})</h3>`;
      
      criticas.forEach(o => {
        criticasDiv.innerHTML += `
          <div class="ocorrencia-critica">
            <strong>${o.Concelho || '‚Äî'} - ${o.Freguesia || o.Localidade || '‚Äî'}</strong><br>
            üë®‚Äçüöí ${o.Operacionais || 0} | üöí ${o.NumeroMeiosTerrestresEnvolvidos || 0} | üöÅ ${o.NumeroMeiosAereosEnvolvidos || 0} | üö§ ${o.NumeroMeiosAquaticos || 0}
          </div>
        `;
      });

      container.appendChild(criticasDiv);
    }
  }

  concelhoFiltro.addEventListener('change', atualizarTabelaEcards);
  freguesiaFiltro.addEventListener('change', atualizarTabelaEcards);
  estadoFiltro.addEventListener('change', atualizarTabelaEcards);
  naturezaFiltro.addEventListener('change', atualizarTabelaEcards);
  pesquisaInput.addEventListener('input', atualizarTabelaEcards);
  document.getElementById('limparFiltros').addEventListener('click', () => {
    concelhoFiltro.value = '';
    freguesiaFiltro.value = '';
    estadoFiltro.value = '';
    naturezaFiltro.value = '';
    pesquisaInput.value = '';
    atualizarTabelaEcards();
  });
</script>
</body>
</html>
