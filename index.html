<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>OcorrÃªncias Ativas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    .dark-mode table {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }

    .dark-mode th {
      background-color: #2c2c2c;
    }

    .dark-mode td {
      border-color: #444;
      color: #e0e0e0;
    }

    .dark-mode select,
    .dark-mode input,
    .dark-mode button {
      background-color: #2c2c2c;
      color: #e0e0e0;
      border: 1px solid #555;
    }

    #modoToggle {
      margin-bottom: 20px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    #filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    select, input {
      padding: 6px;
      font-size: 14px;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .mapa-estatisticas {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    #map {
      flex: 2;
      height: 900px;
    }

    #estatisticas {
      flex: 1;
      font-size: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
    }

    .dark-mode #estatisticas {
      background-color: #1e1e1e;
      border-color: #444;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .estado-conclusao { background-color: #d4f4d7; color: #000; }
    .estado-curso     { background-color: #f8d4d4; color: #000; }
    .estado-despacho  { background-color: #ffe5b4; color: #000; }
    .estado-resolucao { background-color: #d4e4f8; color: #000; }

    .dark-mode .estado-conclusao { background-color: #2e4f2e; color: #e0e0e0; }
    .dark-mode .estado-curso     { background-color: #5a2e2e; color: #e0e0e0; }
    .dark-mode .estado-despacho  { background-color: #5a4a2e; color: #e0e0e0; }
    .dark-mode .estado-resolucao { background-color: #2e3e5a; color: #e0e0e0; }

    @media (max-width: 800px) {
      .mapa-estatisticas {
        flex-direction: column;
      }
      #map {
        height: 400px;
      }
    }

    @media (max-width: 600px) {
      #filtros {
        flex-direction: column;
      }
      select, input, button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <button id="modoToggle">ðŸŒ™ Alternar Modo</button>

  <h1>OcorrÃªncias Ativas em Portugal</h1>

  <div id="filtros">
    <select id="distritoFiltro"><option value="">Distrito</option></select>
    <select id="concelhoFiltro"><option value="">Concelho</option></select>
    <select id="freguesiaFiltro"><option value="">Freguesia</option></select>
    <select id="estadoFiltro"><option value="">Estado</option></select>
    <select id="naturezaFiltro"><option value="">Natureza</option></select>
    <input type="text" id="pesquisa" placeholder="Pesquisar..." />
    <button id="limparFiltros">Limpar Filtros</button>
  </div>

  <div class="mapa-estatisticas">
    <div id="map"></div>
    <div id="estatisticas"></div>
  </div>

  <div class="table-wrapper">
    <table id="ocorrencias">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Distrito</th>
          <th>Concelho</th>
          <th>Freguesia</th>
          <th>LocalizaÃ§Ã£o</th>
          <th>Natureza</th>
          <th>Estado</th>
          <th>Operacionais</th>
          <th>VeÃ­culos</th>
          <th>AÃ©reos</th>
          <th>AquÃ¡ticos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  function formatarDataHora(dataISO) {
    if (!dataISO) return 'â€”';
    const d = new Date(dataISO);
    return isNaN(d) ? 'â€”' : d.toLocaleString('pt-PT');
  }
  const tabela = document.querySelector('#ocorrencias tbody');
  const distritoFiltro = document.getElementById('distritoFiltro');
  const concelhoFiltro = document.getElementById('concelhoFiltro');
  const freguesiaFiltro = document.getElementById('freguesiaFiltro');
  const estadoFiltro = document.getElementById('estadoFiltro');
  const naturezaFiltro = document.getElementById('naturezaFiltro');
  const pesquisaInput = document.getElementById('pesquisa');
  const modoToggle = document.getElementById('modoToggle');
  const map = L.map('map').setView([39.5, -8], 7);
  let marcadores = [];
  let todasOcorrencias = [];

  const novaAPI = 'https://prociv-agserver.geomai.mai.gov.pt/arcgis/rest/services/Ocorrencias_Base/FeatureServer/0/query?f=geojson&where=1=1&outFields=*';
  

  if (localStorage.getItem('modo') === 'dark') {
    document.body.classList.add('dark-mode');
  }

  modoToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const modoAtual = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
    localStorage.setItem('modo', modoAtual);
  });

  function formatarDataHora(data, hora) {
    return (data && hora) ? `${data} ${hora}` : 'â€”';
  }

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // ðŸ”„ LÃ³gica hÃ­brida
  fetch(novaAPI)
    .then(res => res.json())
    .then(data => {
      const ocorrencias = extrairOcorrenciasValidas(data);
      if (ocorrencias.length > 0) {
        todasOcorrencias = ocorrencias;
        preencherFiltros(ocorrencias);
        atualizarTabelaEMapa();
      } else {
        console.warn("Nova API sem dados Ãºteis. A usar fallback.");
        fetch(apiFallback)
          .then(res => res.json())
          .then(data => {
            const ocorrencias = extrairDoFormatoAntigo(data);
            todasOcorrencias = ocorrencias;
            preencherFiltros(ocorrencias);
            atualizarTabelaEMapa();
          });
      }
    })
    .catch(() => {
      console.warn("Erro na nova API. A usar fallback.");
      fetch(apiFallback)
        .then(res => res.json())
        .then(data => {
          const ocorrencias = extrairDoFormatoAntigo(data);
          todasOcorrencias = ocorrencias;
          preencherFiltros(ocorrencias);
          atualizarTabelaEMapa();
        });
    });

  // ðŸ§  Extrair dados vÃ¡lidos da nova API
  function extrairOcorrenciasValidas(resposta) {
    return resposta.features
      .map(f => ({ ...f.properties, coordinates: f.geometry.coordinates }))
      .filter(o => o.Estado && o.Natureza && o.Distrito && Array.isArray(o.coordinates));
  }

  // ðŸ”„ Extrair dados do formato antigo
  function extrairDoFormatoAntigo(data) {
  const lista = Array.isArray(data) ? data : data.data;
  if (!Array.isArray(lista)) {
    console.warn("Formato inesperado na API antiga:", data);
    return [];
  }

  return lista.map(o => ({
    DataOcorrencia: o.date?.created?.split(' ')[0],
    HoraOcorrencia: o.date?.created?.split(' ')[1],
    Distrito: o.location?.district,
    Concelho: o.location?.county,
    Freguesia: o.location?.parish,
    Localizacao: o.location?.location,
    Natureza: o.occurrence?.natureza,
    Estado: o.occurrence?.status,
    MeiosHumanos: o.means_at_to?.man,
    MeiosTerrestres: o.means_at_to?.terrain,
    MeiosAereos: o.means_at_to?.aerial,
    MeiosAquaticos: o.means_at_to?.aquatic,
    coordinates: [
      parseFloat(o.coordinates?.longitude),
      parseFloat(o.coordinates?.latitude)
    ]
  })).filter(o =>
    o.Estado &&
    o.Natureza &&
    o.Distrito &&
    Array.isArray(o.coordinates) &&
    !isNaN(o.coordinates[0]) &&
    !isNaN(o.coordinates[1])
  );
}

  function preencherFiltros(data) {
    const distritos = [...new Set(data.map(o => o.Distrito).filter(Boolean))];
    const concelhos = [...new Set(data.map(o => o.Concelho).filter(Boolean))];
    const freguesias = [...new Set(data.map(o => o.Freguesia).filter(Boolean))];
    const estados = [...new Set(data.map(o => o.Estado).filter(Boolean))];
    const naturezas = [...new Set(data.map(o => o.Natureza).filter(Boolean))];

    [distritos, concelhos, freguesias, estados, naturezas].forEach((lista, i) => {
      const filtro = [distritoFiltro, concelhoFiltro, freguesiaFiltro, estadoFiltro, naturezaFiltro][i];
      lista.forEach(valor => {
        const opt = document.createElement('option');
        opt.value = valor;
        opt.textContent = valor;
        filtro.appendChild(opt);
      });
    });
  }

  function atualizarTabelaEMapa() {
    const distrito = distritoFiltro.value;
    const concelho = concelhoFiltro.value;
    const freguesia = freguesiaFiltro.value;
    const estado = estadoFiltro.value;
    const natureza = naturezaFiltro.value;
    const pesquisa = pesquisaInput.value.toLowerCase();

    const filtradas = todasOcorrencias.filter(o => {
      const texto = `${o.Distrito} ${o.Concelho} ${o.Freguesia} ${o.Localizacao} ${o.Estado} ${o.Natureza}`.toLowerCase();
      return (!distrito || o.Distrito === distrito) &&
             (!concelho || o.Concelho === concelho) &&
             (!freguesia || o.Freguesia === freguesia) &&
             (!estado || o.Estado === estado) &&
             (!natureza || o.Natureza === natureza) &&
             (!pesquisa || texto.includes(pesquisa));
    });

    const total = filtradas.length;
    let operacionais = 0, veiculos = 0, aereos = 0, aquaticos = 0;
    const contagemNaturezas = {};
    const contagemDistritos = {};

    filtradas.forEach(o => {
      operacionais += typeof o.MeiosHumanos === 'number' ? o.MeiosHumanos : 0;
      veiculos     += typeof o.MeiosTerrestres === 'number' ? o.MeiosTerrestres : 0;
      aereos       += typeof o.MeiosAereos === 'number' ? o.MeiosAereos : 0;
      aquaticos    += typeof o.MeiosAquaticos === 'number' ? o.MeiosAquaticos : 0;

      if (o.Natureza) contagemNaturezas[o.Natureza] = (contagemNaturezas[o.Natureza] || 0) + 1;
      if (o.Distrito) contagemDistritos[o.Distrito] = (contagemDistritos[o.Distrito] || 0) + 1;
      console.log("DataInicioOcorrencia:", o.DataInicioOcorrencia);

    });

    let naturezaHTML = '<h4>Por tipo de ocorrÃªncia:</h4><ul>';
    for (const [tipo, qtd] of Object.entries(contagemNaturezas)) {
      naturezaHTML += `<li>${tipo}: ${qtd}</li>`;
    }
    naturezaHTML += '</ul>';

    let distritoHTML = '<h4>Por distrito:</h4><ul>';
    for (const [nome, qtd] of Object.entries(contagemDistritos)) {
      distritoHTML += `<li>${nome}: ${qtd}</li>`;
    }
    distritoHTML += '</ul>';

    document.getElementById('estatisticas').innerHTML = `
      <h3>ðŸ“Š EstatÃ­sticas</h3>
      <p><strong>OcorrÃªncias visÃ­veis:</strong> ${total}</p>
      <p><strong>Operacionais:</strong> ${operacionais}</p>
      <p><strong>VeÃ­culos:</strong> ${veiculos}</p>
      <p><strong>AÃ©reos:</strong> ${aereos}</p>
      <p><strong>AquÃ¡ticos:</strong> ${aquaticos}</p>
      ${naturezaHTML}
      ${distritoHTML}
    `;

    tabela.innerHTML = '';
    marcadores.forEach(m => map.removeLayer(m));
    marcadores = [];

    const grupoCoordenadas = [];

    filtradas.forEach(o => {
      const linha = document.createElement('tr');

      const estadoTexto = o.Estado ? o.Estado.toLowerCase() : '';
      let classeEstado = '';
      if (estadoTexto.includes('conclusÃ£o')) classeEstado = 'estado-conclusao';
      else if (estadoTexto.includes('curso')) classeEstado = 'estado-curso';
      else if (estadoTexto.includes('despacho')) classeEstado = 'estado-despacho';
      else if (estadoTexto.includes('resoluÃ§Ã£o')) classeEstado = 'estado-resolucao';
      if (classeEstado) linha.classList.add(classeEstado);

      linha.innerHTML = `
        <td>${
  formatarDataHora(
    o.DataInicioOcorrencia ||
    (o.DataOcorrencia && o.HoraOcorrencia
      ? `${o.DataOcorrencia}T${o.HoraOcorrencia}`
      : null)
  )
}</td>
        <td>${o.Distrito || 'â€”'}</td>
        <td>${o.Concelho || 'â€”'}</td>
        <td>${o.Freguesia || 'â€”'}</td>
        <td>${o.Localizacao || 'â€”'}</td>
        <td>${o.Natureza || 'â€”'}</td>
        <td>${o.Estado || 'â€”'}</td>
        <td>${typeof o.MeiosHumanos === 'number' ? o.MeiosHumanos : 0}</td>
        <td>${typeof o.MeiosTerrestres === 'number' ? o.MeiosTerrestres : 0}</td>
        <td>${typeof o.MeiosAereos === 'number' ? o.MeiosAereos : 0}</td>
        <td>${typeof o.MeiosAquaticos === 'number' ? o.MeiosAquaticos : 0}</td>
      `;
      tabela.appendChild(linha);

      const [lon, lat] = o.coordinates || [];
      if (!isNaN(lat) && !isNaN(lon)) {
        grupoCoordenadas.push([lat, lon]);

        const popupContent = `
          <strong>${o.Localizacao || 'LocalizaÃ§Ã£o desconhecida'}</strong><br>
          <em>${formatarDataHora(o.DataInicioOcorrencia)}</em><br><br>
          <strong>Distrito:</strong> ${o.Distrito || 'â€”'}<br>
          <strong>Concelho:</strong> ${o.Concelho || 'â€”'}<br>
          <strong>Freguesia:</strong> ${o.Freguesia || 'â€”'}<br>
          <strong>Natureza:</strong> ${o.Natureza || 'â€”'}<br>
          <strong>Estado:</strong> ${o.Estado || 'â€”'}<br><br>
          <strong>Operacionais:</strong> ${typeof o.MeiosHumanos === 'number' ? o.MeiosHumanos : 'â€”'}<br>
          <strong>VeÃ­culos:</strong> ${typeof o.MeiosTerrestres === 'number' ? o.MeiosTerrestres : 'â€”'}<br>
          <strong>AÃ©reos:</strong> ${typeof o.MeiosAereos === 'number' ? o.MeiosAereos : 'â€”'}<br>
          <strong>AquÃ¡ticos:</strong> ${typeof o.MeiosAquaticos === 'number' ? o.MeiosAquaticos : 'â€”'}
        `;

        const marcador = L.marker([lat, lon])
          .addTo(map)
          .bindPopup(popupContent);

        marcadores.push(marcador);
      }
    });

    if (grupoCoordenadas.length > 0) {
      const bounds = L.latLngBounds(grupoCoordenadas);
      map.fitBounds(bounds, { padding: [50, 50] });
    } else {
      map.setView([39.5, -8], 7);
    }
  }

  distritoFiltro.addEventListener('change', atualizarTabelaEMapa);
  concelhoFiltro.addEventListener('change', atualizarTabelaEMapa);
  freguesiaFiltro.addEventListener('change', atualizarTabelaEMapa);
  estadoFiltro.addEventListener('change', atualizarTabelaEMapa);
  naturezaFiltro.addEventListener('change', atualizarTabelaEMapa);
  pesquisaInput.addEventListener('input', atualizarTabelaEMapa);

  document.getElementById('limparFiltros').addEventListener('click', () => {
    distritoFiltro.value = '';
    concelhoFiltro.value = '';
    freguesiaFiltro.value = '';
    estadoFiltro.value = '';
    naturezaFiltro.value = '';
    pesquisaInput.value = '';
    atualizarTabelaEMapa();
  });
</script>
</body>
</html>
